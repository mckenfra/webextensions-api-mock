# WebExtensions API Mock

Automatically generated [`sinon stubs`](https://sinonjs.org/releases/latest/stubs/), together with types, for the [WebExtensions API](https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/API). Currently based on the Firefox version _70.0.1_ schema. Comes with an API and CLI that lets you update the schema and types to the _latest stable Firefox version_, thanks to [`webextensions-schema`](https://github.com/stoically/webextensions-schema).

Instead of just stubbing the API it's possible to enable [faked behavior](#fake-behavior) for some of them.

To get globally declared `window.browser` types for production code I'd recommened installing `@types/firefox-webext-browser`, those are automatically generated by [jsmnbom/definitelytyped-firefox-webext-browser](https://github.com/jsmnbom/definitelytyped-firefox-webext-browser)

## Install

```shell
npm install --save-dev sinon webextensions-api-mock @types/sinon
```

**Important**: `sinon` is a peer dependency, so you have to install it, and its @types yourself. That's because it can otherwise lead to unexpected assertion behavior when sinon does `instanceof` checks internally. It also allows to upgrade sinon without the need to bump the version in `webextensions-api-mock`.

## Usage

```ts
import browserMock from 'webextensions-api-mock';
// or
// const { default: browserMock } = require('webextensions-api-mock');

const browser = browserMock();
```

All `browser` methods are now [`sinon stubs`](https://sinonjs.org/releases/latest/stubs/) and hence you can use them as usual in your test, e.g. if your production code calls `browser.tabs.create()` you can assert it

```ts
assert(browser.tabs.create.called);
```

To trigger event listeners, you can use the [`yield` method on stubs](https://sinonjs.org/releases/latest/stubs/).

```ts
browser.tabs.onCreated.addListener.yield();
```

Every call to `browserMock()` creates a new `browser` object based on a new
[`sinon sandbox`](https://sinonjs.org/releases/latest/sandbox/). The sinon sandbox itself is exposed as `sinonSandbox` property on the
`browser` object. So to e.g. reset the history of all browser stubs, you'd call

```ts
browser.sinonSandbox.resetHistory();
```

## Update schema and types

Update the schema and types to the latest available stable Firefox version. Feel
free to PR updated schema and types if they're not up-to-date.

### Using API

```ts
import { update } from 'webextensions-api-mock';
// or
// const { update } = require('webextensions-api-mock');

(async () => {
  await update();
})();
```

### Using CLI

```
webextensions-api-mock update
```

## Fake Behavior

Instead of just stubbing APIs it's also possible to actually fake API behavior. To enable fakes pass the fake option into `browserMock()`

To enables all fakes:

```ts
browserMock({ fake: true });
```

To enable only certain fakes:

```ts
browserMock({ fake: ['storage', 'tabs'] });
```

### Available Fakes

#### [alarms](https://developer.mozilla.org/Add-ons/WebExtensions/API/alarms)

- create
  - triggers: `onAlarm`
- get
- getAll
- clear
- clearAll

#### [contextualIdentities](https://developer.mozilla.org/Add-ons/WebExtensions/API/contextualIdentities)

- create
  - triggers: `onCreated`
- get
- remove
  - triggers: `onRemoved`
- query

#### [cookies](https://developer.mozilla.org/Add-ons/WebExtensions/API/cookies)

- get
- getAll
- getAllCookieStores
- remove
- set

#### [i18n](https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/API/i18n)

- getAcceptLanguages
  - Returns `['en-US']` by default, can be overwritten by `_setAcceptLanguages`
- getMessage
  - Returns results based on the `locales` and `default_locale` passed as [`options`](#exported-default-functionoptions)
- getUILanguage
  - Returns `en-US` by default, can be overwritten by `_setUILanguage`
- detectLanguage
  - Returns a Promise that resolves to the result of `getUILanguage`

#### [tabs](https://developer.mozilla.org/Add-ons/WebExtensions/API/tabs)

- create
  - Any parameter can be passed in
  - triggers: `onCreated`
    - If `url` is given that doesn't start with `about:` or `moz-ext:`
      - `webRequest.onBeforeRequest`
      - `webRequest.onCompleted`
      - `onUpdated`
- update
  - triggers: `onUpdated`
    - If `url` is given that doesn't start with `about:` or `moz-ext:`
      - `webRequest.onBeforeRequest`
      - `webRequest.onCompleted`
      - `onUpdated`
- get
- query
- remove
  - triggers: `onRemoved`

#### [storage](https://developer.mozilla.org/Add-ons/WebExtensions/API/storage)

- local
  - get
  - remove
  - set
